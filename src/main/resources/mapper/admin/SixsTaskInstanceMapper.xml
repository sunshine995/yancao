<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="com.office.yancao.mapper.admin.SixsTaskInstanceMapper">

    <resultMap id="BaseResultMap" type="com.office.yancao.entity.admin.SixsTaskInstance">
        <id column="id" property="id" />
        <result column="template_id" property="templateId" />
        <result column="employee_id" property="employeeId" />
        <result column="scheduled_date" property="scheduledDate" />
        <result column="planned_completion_time" property="plannedCompletionTime" />
        <result column="status" property="status" />
        <result column="submitted_images" property="submittedImages" typeHandler="com.office.yancao.untils.JsonListTypeHandler"/>
        <result column="completion_notes" property="completionNotes" />
        <result column="submitted_at" property="submittedAt" />
        <result column="spot_check_status" property="spotCheckStatus" />
        <result column="spot_checker_id" property="spotCheckerId" />
        <result column="spot_check_time" property="spotCheckTime" />
        <result column="spot_check_result" property="spotCheckResult" />
        <result column="spot_check_notes" property="spotCheckNotes" />
        <result column="spot_check_images" property="spotCheckImages" typeHandler="com.office.yancao.untils.JsonListTypeHandler"/>
        <result column="created_at" property="createdAt" />
        <result column="updated_at" property="updatedAt" />
    </resultMap>

    <resultMap id="SixTaskInstanceDTOResultMap" type="com.office.yancao.dto.admin.SixTaskInstanceDTO">
        <!-- 首先继承BaseResultMap，如果SixTaskInstanceDTO继承了SixsTaskInstance，或者字段重合部分多的话 -->
        <id column="id" property="id" />
        <result column="template_id" property="templateId" />
        <result column="employee_id" property="employeeId" />
        <result column="employeeName" property="employeeName" />
        <result column="scheduled_date" property="scheduledDate" />
        <result column="planned_completion_time" property="plannedCompletionTime" />
        <result column="status" property="status" />
        <result column="submitted_images" property="submittedImages" typeHandler="com.office.yancao.untils.JsonListTypeHandler"/>
        <result column="completion_notes" property="completionNotes" />
        <result column="submitted_at" property="submittedAt" />
        <result column="spot_check_status" property="spotCheckStatus" />
        <result column="spot_checker_id" property="spotCheckerId" />
        <result column="spotCheckerName" property="spotCheckerName" />
        <result column="spot_check_time" property="spotCheckTime" />
        <result column="spot_check_result" property="spotCheckResult" />
        <result column="spot_check_notes" property="spotCheckNotes" />
        <result column="spot_check_images" property="spotCheckImages" typeHandler="com.office.yancao.untils.JsonListTypeHandler"/>
        <!-- 模板表字段 -->
        <result column="template_name" property="templateName" />
        <result column="group_name" property="groupName" />
        <result column="shift" property="shift" />
        <result column="weekday" property="weekday" />
        <result column="task_content" property="taskContent" />
        <result column="task_standard" property="taskStandard" />
        <result column="created_at" property="createdAt" />
        <result column="updated_at" property="updatedAt" />
    </resultMap>

    <sql id="Base_Column_List">
        id, template_id, employee_id, scheduled_date, planned_completion_time, status,
        submitted_images, completion_notes, submitted_at, spot_check_status, spot_checker_id,
        spot_check_time, spot_check_result, spot_check_notes, spot_check_images,
        created_at, updated_at
    </sql>

    <!-- 插入任务实例 -->
    <insert id="insert" parameterType="com.office.yancao.entity.admin.SixsTaskInstance"
            useGeneratedKeys="true" keyProperty="id">
        INSERT INTO sixs_task_instances (
            template_id, employee_id, scheduled_date, planned_completion_time, status,
            spot_check_status, created_at, updated_at
        ) VALUES (
                     #{templateId}, #{employeeId}, #{scheduledDate}, #{plannedCompletionTime}, #{status},
                     #{spotCheckStatus}, NOW(), NOW()
                 )
    </insert>

    <!-- 批量插入任务实例 -->
    <insert id="batchInsert" parameterType="java.util.List">
        INSERT INTO sixs_task_instances (
        template_id, employee_id, scheduled_date, planned_completion_time, status,
        spot_check_status, created_at, updated_at
        ) VALUES
        <foreach collection="instances" item="instance" separator=",">
            (
            #{instance.templateId}, #{instance.employeeId}, #{instance.scheduledDate},
            #{instance.plannedCompletionTime}, #{instance.status}, #{instance.spotCheckStatus},
            NOW(), NOW()
            )
        </foreach>
    </insert>

    <!-- 根据员工和日期查询任务实例 -->
    <select id="findByEmployeeAndDate" resultMap="BaseResultMap">
        SELECT
        <include refid="Base_Column_List" />
        FROM sixs_task_instances
        WHERE employee_id = #{employeeId}
        AND scheduled_date = #{scheduledDate}
        ORDER BY planned_completion_time
    </select>

    <!-- 检查任务实例是否已存在 -->
    <select id="countByTemplateAndEmployeeAndDate" resultType="java.lang.Integer">
        SELECT COUNT(*)
        FROM sixs_task_instances
        WHERE template_id = #{templateId}
          AND employee_id = #{employeeId}
          AND scheduled_date = #{scheduledDate}
    </select>

    <!-- 根据日期查询所有任务实例 -->
    <select id="findByDate" resultMap="BaseResultMap">
        SELECT
        <include refid="Base_Column_List" />
        FROM sixs_task_instances
        WHERE scheduled_date = #{scheduledDate}
        ORDER BY employee_id, planned_completion_time
    </select>

    <!-- 新增：更新任务实例 -->
    <update id="updateById">
        UPDATE sixs_task_instances
        <set>
            <if test="status != null and status != ''">status = #{status},</if>
            <if test="submittedImages != null">submitted_images = #{submittedImages, typeHandler=com.office.yancao.untils.JsonListTypeHandler},</if>
            <if test="completionNotes != null">completion_notes = #{completionNotes},</if>
            <if test="submittedAt != null">submitted_at = #{submittedAt},</if>
            <if test="updatedAt != null">updated_at = #{updatedAt},</if>
            <if test="spotCheckStatus != null and spotCheckStatus != ''">spot_check_status = #{spotCheckStatus},</if>
            <if test="spotCheckerId != null">spot_checker_id = #{spotCheckerId},</if>
            <if test="spotCheckTime != null">spot_check_time = #{spotCheckTime},</if>
            <if test="spotCheckResult != null">spot_check_result = #{spotCheckResult},</if>
            <if test="spotCheckNotes != null">spot_check_notes = #{spotCheckNotes},</if>
            <if test="spotCheckImages != null">spot_check_images = #{spotCheckImages, typeHandler=com.office.yancao.untils.JsonListTypeHandler}</if>
        </set>
        WHERE id = #{id}
    </update>

    <select id="selectById" resultMap="BaseResultMap">
        SELECT * FROM sixs_task_instances WHERE id = #{id}
    </select>

    <select id="selectSpotCheckTasks" resultMap="SixTaskInstanceDTOResultMap">
        SELECT
        sti.id,
        sti.template_id,
        sti.employee_id,
        e1.username as employeeName,
        sti.scheduled_date,
        sti.planned_completion_time,
        sti.status,
        sti.submitted_images,
        sti.completion_notes,
        sti.submitted_at,
        sti.spot_check_status,
        sti.spot_checker_id,
        e2.username as spotCheckerName,
        sti.spot_check_time,
        sti.spot_check_result,
        sti.spot_check_notes,
        sti.spot_check_images,
        stt.template_name,
        stt.group_name,
        stt.shift,
        stt.weekday,
        stt.task_content,
        stt.task_standard,
        stt.created_at,
        stt.updated_at
        FROM sixs_task_instances sti
        LEFT JOIN sixs_task_templates stt ON sti.template_id = stt.id
        LEFT JOIN user_info e1 ON sti.employee_id = e1.id
        LEFT JOIN user_info e2 ON sti.spot_checker_id = e2.id

    </select>


    <select id="getSixTaskById" resultMap="SixTaskInstanceDTOResultMap">
        SELECT
            sti.id,
            sti.template_id,
            sti.employee_id,
            e1.username as employeeName,
            sti.scheduled_date,
            sti.planned_completion_time,
            sti.status,
            sti.submitted_images,
            sti.completion_notes,
            sti.submitted_at,
            sti.spot_check_status,
            sti.spot_checker_id,
            e2.username as spotCheckerName,
            sti.spot_check_time,
            sti.spot_check_result,
            sti.spot_check_notes,
            sti.spot_check_images,
            stt.template_name,
            stt.group_name,
            stt.shift,
            stt.weekday,
            stt.task_content,
            stt.task_standard,
            stt.created_at,
            stt.updated_at
        FROM sixs_task_instances sti
         LEFT JOIN sixs_task_templates stt ON sti.template_id = stt.id
         LEFT JOIN user_info e1 ON sti.employee_id = e1.id
         LEFT JOIN user_info e2 ON sti.spot_checker_id = e2.id
        where sti.id = #{taskId}
    </select>


</mapper>