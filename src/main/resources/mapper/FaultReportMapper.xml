<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="com.office.yancao.mapper.FaultReportMapper">

    <!-- 结果映射 -->
    <resultMap id="FaultReportMap" type="com.office.yancao.entity.FaultReport">
        <id property="id" column="id"/>
        <result property="reporterId" column="reporter_id"/>
        <result property="line" column="line"/>
        <result property="section" column="section"/>
        <result property="type" column="type"/>
        <result property="description" column="description"/>
        <result property="status" column="status"/>
        <result property="reportTime" column="report_time"/>
        <result property="repairmanId" column="repairman_id"/>
        <result property="createdTime" column="created_at"/>
        <result property="arrivalTime" column="arrival_time"/>
        <result property="repairTime" column="repair_time"/>
        <result property="durationMinutes" column="duration_minutes"/>
    </resultMap>

    <!-- 插入故障报告 -->
    <insert id="insert" useGeneratedKeys="true" keyProperty="id">
        INSERT INTO fault_reports (
            reporter_id,
            line,
            section,
            type,
            description,
            status,
            report_time,
            created_Time
        ) VALUES (
                     #{reporterId},
                     #{line},
                     #{section},
                     #{type},
                     #{description},
                     #{status},
                     #{reportTime},
                     NOW()
                 )
    </insert>

    <!-- 根据ID查询 -->
    <select id="findById" resultMap="FaultReportMap">
        SELECT * FROM fault_reports WHERE id = #{id}
    </select>

    <!-- 更新为已到达状态 -->
    <update id="updateToArrived">
        UPDATE fault_reports
        SET
            arrival_time = NOW(),
            status = 'progress'
        WHERE
            id = #{id}
          AND status = 'acknowledged'
    </update>

    <!-- 更新为已修复状态 -->
    <update id="updateToRepaired">
        UPDATE fault_reports
        SET
            repair_time = NOW(),
            status = #{status},
            duration_minutes = #{durationMinutes},
            repair_notes = #{repairNotes}
        WHERE
            id = #{id}
          AND status = 'progress'
    </update>

    <update id="updateToGet">
        UPDATE fault_reports
        SET
            query_time = NOW(),
            status = #{status}
        WHERE
            id = #{id}
          AND status = 'reported'
    </update>

    <!-- 分页查询所有 -->
    <select id="findAll" resultMap="FaultReportMap">
        SELECT * FROM fault_reports
        ORDER BY report_time DESC
            LIMIT #{offset}, #{limit}
    </select>

    <select id="selectByType" parameterType="string" resultMap="FaultReportMap">
        SELECT *
        FROM fault_reports
        WHERE report_time >= CURDATE()

        <choose>
            <!-- 情况1: type = 'device' → 查询 type IN ('1', '2') -->
            <when test="type != null and type == 'device'.toString()">
                AND type IN ('electrical', 'mechanical')
            </when>

            <!-- 情况2: type = 'Type' 或其他表示“全部”的值 → 不加 type 条件 -->
            <when test="type == null or type == ''">
                <!-- 无额外条件 -->
            </when>

            <!-- 情况3: 其他具体 type 值 → 精确匹配 -->
            <otherwise>
                AND type = #{type}
            </otherwise>
        </choose>

        ORDER BY report_time DESC
    </select>

    <select id="selectByAdmin" parameterType="string" resultMap="FaultReportMap">
        SELECT *
        FROM fault_reports
        WHERE report_time >= CURDATE()
        and type = #{faultType}
        ORDER BY report_time DESC
    </select>

    <select id="selectByUserId" parameterType="long" resultMap="FaultReportMap">
        SELECT *
        FROM fault_reports
        WHERE reporter_id = #{userId}
          AND report_time >= CURDATE()
        <choose>
            <!-- 情况1: type = 'device' → 查询 type IN ('1', '2') -->
            <when test="type != null and type == 'device'.toString()">
                AND type IN ('electrical', 'mechanical')
            </when>

            <!-- 情况2: type = 'Type' 或其他表示“全部”的值 → 不加 type 条件 -->
            <when test="type == null or type == ''">
                <!-- 无额外条件 -->
            </when>

            <!-- 情况3: 其他具体 type 值 → 精确匹配 -->
            <otherwise>
                AND type = #{type}
            </otherwise>
        </choose>

        ORDER BY report_time DESC
    </select>

<!--    更新管理员处理质量和生产异常-->
<!--    <update id="updateByAdmin">-->
<!--        UPDATE fault_reports-->
<!--        SET-->
<!--            status = #{status}-->
<!--        WHERE-->
<!--            id = #{id}-->
<!--          AND status = 'reported'-->
<!--    </update>-->
</mapper>