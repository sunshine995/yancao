<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" 
"http://mybatis.org/dtd/mybatis-3-mapper.dtd">

<mapper namespace="com.office.yancao.mapper.TobaccoRecordMapper">

    <!-- 结果集映射：实体类与数据库字段对应 -->
    <resultMap id="TobaccoRecordMap" type="com.office.yancao.entity.TobaccoRecord">
        <id column="id" property="id"/>
        <result column="brand" property="brand"/>
        <result column="batch_number" property="batchNumber"/>
        <result column="is_timeout" property="isTimeout"/>
        <result column="exit_work_order_id" property="exitWorkOrderId"/> <!-- 退出工单ID -->
        <result column="add_work_order_id" property="addWorkOrderId"/> <!-- 加入工单ID -->
        <result column="status" property="status"/>
        <result column="weight" property="weight"/>
        <result column="operate_time" property="operateTime"/>
        <result column="submit_status" property="submitStatus"/>
    </resultMap>

    <!-- 1. 带搜索关键字：查询所有工单的退出烟叶（按牌号/批次号模糊搜索） -->
    <select id="selectAllExitTobaccosWithKeyword" resultMap="TobaccoRecordMap">
        SELECT 
            id, brand, batch_number, is_timeout,
            exit_work_order_id, add_work_order_id, status, weight, operate_time, submit_status
        FROM tobacco_record
        WHERE 
            status = 'exit'  -- 只查退出状态
            AND (
                brand LIKE CONCAT('%', #{keyword}, '%') 
                OR batch_number LIKE CONCAT('%', #{keyword}, '%')
            )
    </select>

    <!-- 2. 不带搜索关键字：查询所有工单的全部退出烟叶 -->
    <select id="selectAllExitTobaccosWithoutKeyword" resultMap="TobaccoRecordMap">
        SELECT 
            id, brand, batch_number, is_timeout,
            exit_work_order_id, add_work_order_id, status, weight, operate_time, submit_status
        FROM tobacco_record
        WHERE status = 'exit'  -- 只查退出状态
    </select>

    <!-- 3. 插入退出烟叶记录 -->
    <insert id="insertExitTobacco" parameterType="com.office.yancao.entity.TobaccoRecord">
    INSERT INTO tobacco_record (
        brand, batch_number, is_timeout, status, 
        weight, operate_time, submit_status,
        exit_work_order_id, add_work_order_id
    ) VALUES (
        #{brand}, #{batchNumber}, #{isTimeout}, 'exit',
        #{weight}, #{operateTime}, 'unsubmitted',
        #{exitWorkOrderId}, NULL  
    )
</insert>

    <!-- 4. 根据工单ID查询已加入的烟叶 -->
<select id="selectAddedTobaccosByWorkOrderId" resultMap="TobaccoRecordMap">
    SELECT * FROM tobacco_record
    WHERE status = 'added' 
      AND add_work_order_id = #{workOrderId}  -- 关联加入的工单ID
</select>

<!-- 移除按钮 更新为退出状态 -->
    <update id="updateToExit">
        UPDATE tobacco_record
        SET status = 'exit',
            add_work_order_id = null,
            operate_time = #{newOperateTime}
        WHERE brand = #{brand}
          AND batch_number = #{batchNumber}
          AND add_work_order_id = #{addWorkOrderId}
          AND status = 'added'
    </update>

    <!-- 更新为已加入状态 -->
    <update id="updateToAdded">
        UPDATE tobacco_record
        SET status = 'added',
            add_work_order_id = #{addWorkOrderId},
            operate_time = #{newOperateTime}
        WHERE brand = #{brand}
          AND batch_number = #{batchNumber}
          AND status = 'exit'
    </update>
</mapper>