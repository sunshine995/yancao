<?xml version="1.0" encoding="UTF-8" ?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="com.office.yancao.mapper.DottleBatchMapper">

    <select id="selectBatchList" resultType="com.office.yancao.entity.DottleBatch">
        SELECT
        tb.*,
        tbr.grade_name AS brandName
        FROM dottle_batch tb
        LEFT JOIN tobacco_grade_table tbr ON tb.brand_id = tbr.batch_number
        <where>
            <if test="brandId != null and brandId != ''">
                AND tb.brand_id = #{brandId}
            </if>
            AND tb.days_remaining >= 0
            AND tb.remaining_bags > 0
<!--            <if test="query.status != null">-->
<!--                AND tb.status = #{query.status}-->
<!--            </if>-->
        </where>
        ORDER BY tb.days_remaining
    </select>

    <select id="queryExpireBatch" resultType="com.office.yancao.entity.DottleBatch">
        SELECT
            tb.*,
            tbr.grade_name AS brandName
        FROM dottle_batch tb
                 LEFT JOIN tobacco_grade_table tbr ON tb.brand_id = tbr.batch_number
        WHERE tb.expire_date &lt; NOW()
          AND tb.remaining_bags > 0
          AND tb.status = 'expired'
        ORDER BY tb.expire_date ASC
    </select>

    <update id="updateBatchRemaining">
        UPDATE dottle_batch
        SET remaining_bags = #{remainingBags},
            remaining_weight = #{remainingWeight},
            update_time = NOW()
        WHERE id = #{id}
    </update>

    <insert id="insert" parameterType="com.office.yancao.entity.DottleBatch" useGeneratedKeys="true" keyProperty = "id">
        INSERT INTO dottle_batch (
            batch_id,brand_id,receive_date,expire_date,total_bags,total_weight,remaining_bags,
            remaining_weight,status,days_remaining,shift_type,operator,create_time,update_time
        ) VALUES (
            #{batchId},#{brandId},#{receiveDate},#{expireDate},#{totalBags},#{totalWeight},
                  #{remainingBags},#{remainingWeight},#{status},#{daysRemaining},
               #{shiftType},#{operator},#{createTime},#{updateTime} )
    </insert>

    <!-- 查询批次列表 -->
    <select id="queryAdminBatch" parameterType="map" resultType="com.office.yancao.entity.DottleBatch">
        SELECT
        *,
        tbr.grade_name AS brandName
        FROM dottle_batch
        LEFT JOIN tobacco_grade_table tbr ON brand_id = tbr.batch_number
        <where>
            <if test="brandId != null and brandId != ''">
                AND brand_id = #{brandId}
            </if>
            <if test="status != null and status != ''">
                AND status = #{status}
            </if>
        </where>
        <choose>
            <when test="sortField != null and sortField != ''">
                ORDER BY
                <choose>
                    <when test="sortField == 'receive_date'">receive_date</when>
                    <when test="sortField == 'days_remaining'">
                        DATEDIFF(expire_date, NOW())
                    </when>
                    <when test="sortField == 'remaining_bags'">remaining_bags</when>
                    <when test="sortField == 'remaining_weight'">remaining_weight</when>
                    <otherwise>create_time</otherwise>
                </choose>
                <choose>
                    <when test="sortOrder == 'asc'">ASC</when>
                    <otherwise>DESC</otherwise>
                </choose>
            </when>
            <otherwise>
                ORDER BY create_time DESC
            </otherwise>
        </choose>
    </select>

    <update id="updateStatusAndDaysRemaining">
        UPDATE dottle_batch
        SET
        days_remaining = DATEDIFF(expire_date, CURDATE()),
        status = CASE
        WHEN DATEDIFF(expire_date, CURDATE()) &lt; 0 THEN 'expired'
        WHEN DATEDIFF(expire_date, CURDATE()) &lt; 4 THEN 'warning'
        ELSE 'normal'
        END
    </update>

</mapper>